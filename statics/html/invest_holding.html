<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹°å…¥é‡‘é¢è®¡ç®—å™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .history-panel {
            flex: 0 0 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 30px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .history-title {
            color: #34495e;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clear-all-btn {
            background: #95a5a6;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 50px;
        }

        .clear-all-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .history-content {
            flex: 1;
            cursor: pointer;
        }

        .delete-btn {
            background: #f8f9fa;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0.7;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 0;
            width: 50px;
        }

        .delete-btn:hover {
            background: #c0392b;
            opacity: 1;
            transform: scale(1.1);
        }

        .history-stock-name {
            font-weight: 700;
            color: #34495e;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .history-amount {
            color: #27ae60;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .history-details {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.6;
        }

        .history-time {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 8px;
            text-align: right;
        }

        .empty-history {
            text-align: center;
            color: #95a5a6;
            padding: 40px 20px;
            font-size: 14px;
        }

        .container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        h1 {
            color: #34495e;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #95a5a6;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #34495e;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 700;
            pointer-events: none;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 16px;
            color: #34495e;
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        #growth {
            padding-right: 40px;
        }

        .hint {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 5px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .radio-label:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .radio-label input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .radio-label input[type="radio"]:checked + .radio-text {
            color: #3498db;
            font-weight: 700;
        }

        .radio-label:has(input[type="radio"]:checked) {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .radio-text {
            color: #34495e;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .query-button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            font-size: 14px !important;
            padding: 12px 20px !important;
            margin: 0 !important;
            width: auto !important;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        .query-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%) !important;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4) !important;
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            border-radius: 6px;
            text-align: center;
            color: white;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-unit {
            font-size: 18px;
            opacity: 0.9;
        }

        .breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 6px;
            display: none;
        }

        .breakdown-title {
            color: #34495e;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .breakdown-value {
            color: #34495e;
            font-weight: 700;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .history-panel {
                flex: 1;
                max-height: 400px;
            }

            .container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- å·¦ä¾§å†å²è®°å½•é¢æ¿ -->
    <div class="history-panel">
        <div class="history-title">
            <span>ğŸ“œ è®¡ç®—å†å²</span>
            <button class="clear-all-btn" onclick="clearAllHistory()" title="æ¸…ç©ºæ‰€æœ‰å†å²">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <div class="history-list" id="historyList">
            <div class="empty-history">æš‚æ— å†å²è®°å½•</div>
        </div>
    </div>

    <!-- å³ä¾§è®¡ç®—å™¨ -->
    <div class="container">
        <h1>ğŸ“Š ä¹°å…¥é‡‘é¢è®¡ç®—å™¨</h1>
        <p class="subtitle">åŸºäºTTM PEGã€å¸‚åœºé¢„æœŸå’ŒæŠ€æœ¯é¢è¯„åˆ†</p>

        <div class="input-group">
            <label for="stockName">è‚¡ç¥¨åç§°</label>
            <div class="input-wrapper" style="display: flex; gap: 10px;">
                <input type="text" id="stockName" placeholder="ä¾‹å¦‚: è´µå·èŒ…å°" style="flex: 1;">
                <button type="button" id="queryBtn" class="query-button" onclick="queryStockData()">
                    ğŸ” æŸ¥è¯¢
                </button>
            </div>
            <div class="hint">è¾“å…¥è‚¡ç¥¨åç§°æˆ–ä»£ç ï¼Œç‚¹å‡»æŸ¥è¯¢æŒ‰é’®è·å–æœ€æ–°æ•°æ®</div>
        </div>

        <div class="input-group">
            <label for="pe">TTM å¸‚ç›ˆç‡ (PE)</label>
            <div class="input-wrapper">
                <input type="number" id="pe" step="0.1" min="0" placeholder="ä¾‹å¦‚: 15.5">
            </div>
            <div class="hint">å½“å‰å¸‚ç›ˆç‡</div>
        </div>

        <div class="input-group">
            <label for="growth">åˆ©æ¶¦åŒæ¯”å¢é•¿ç‡</label>
            <div class="input-wrapper">
                <input type="number" id="growth" step="0.1" placeholder="ä¾‹å¦‚: 25.5">
                <span class="input-suffix">%</span>
            </div>
            <div class="hint">åˆ©æ¶¦å¢é•¿ç™¾åˆ†æ¯”</div>
        </div>

        <div class="input-group">
            <label for="expect">å¸‚åœºé¢„æœŸå€¼ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="expect" value="1">
                    <span class="radio-text">1 - å¾ˆå·®</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="2">
                    <span class="radio-text">2 - è¾ƒå·®</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="3" checked>
                    <span class="radio-text">3 - ä¸­æ€§</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="4">
                    <span class="radio-text">4 - è¾ƒå¥½</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="5">
                    <span class="radio-text">5 - å¾ˆå¥½</span>
                </label>
            </div>
        </div>

        <div class="input-group">
            <label for="tech">æŠ€æœ¯é¢è¯„åˆ†ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="tech" value="0">
                    <span class="radio-text">0 - å·®</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="tech" value="1" checked>
                    <span class="radio-text">1 - ä¸­æ€§</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="tech" value="3">
                    <span class="radio-text">3 - å¥½</span>
                </label>
            </div>
        </div>

        <button onclick="calculate()">è®¡ç®—å»ºè®®é‡‘é¢</button>

        <div class="result" id="result">
            <div class="result-label">å»ºè®®ä¹°å…¥é‡‘é¢</div>
            <div class="result-value" id="positionValue">0</div>
            <div class="result-unit">ä¸‡å…ƒ</div>
        </div>

        <div class="breakdown" id="breakdown">
            <div class="breakdown-title">è®¡ç®—æ˜ç»†</div>
            <div class="breakdown-item">
                <span>TTM å¸‚ç›ˆç‡ (PE)</span>
                <span class="breakdown-value" id="peValue">0</span>
            </div>
            <div class="breakdown-item">
                <span>åˆ©æ¶¦å¢é•¿ç‡</span>
                <span class="breakdown-value" id="growthValue">0%</span>
            </div>
            <div class="breakdown-item" style="padding-top: 10px; border-top: 1px solid #d5d8dc;">
                <span>è®¡ç®—å¾—åˆ° PEG</span>
                <span class="breakdown-value" id="pegValue">0</span>
            </div>
            <div class="breakdown-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #bdc3c7;">
                <span>PEG å¾—åˆ† (40%æƒé‡)</span>
                <span class="breakdown-value" id="pegScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>å¸‚åœºé¢„æœŸå¾—åˆ† (20%æƒé‡)</span>
                <span class="breakdown-value" id="expectScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>æŠ€æœ¯é¢å¾—åˆ† (20%æƒé‡)</span>
                <span class="breakdown-value" id="techScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>å·´è²ç‰¹è¯„åˆ† (20%æƒé‡)</span>
                <span class="breakdown-value" id="buffettScore">0</span>
            </div>
            <div class="breakdown-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #bdc3c7;">
                <span style="color: #34495e; font-weight: 700;">ç»¼åˆå¾—åˆ†</span>
                <span class="breakdown-value" id="totalScore">0</span>
            </div>
        </div>
    </div>
</div>

<script>
    let history = [];

    function queryStockData() {
        const stockName = document.getElementById('stockName').value.trim();
        if (!stockName) {
            alert('è¯·è¾“å…¥è‚¡ç¥¨åç§°æˆ–ä»£ç ï¼');
            return;
        }

        const queryBtn = document.getElementById('queryBtn');
        const originalText = queryBtn.innerHTML;
        queryBtn.innerHTML = 'â³ æŸ¥è¯¢ä¸­...';
        queryBtn.disabled = true;

        fetch(`/invest/query-stock?keyword=${encodeURIComponent(stockName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.Error) {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + data.Error);
                    return;
                }

                if (data.StockData) {
                    const stock = data.StockData;
                    // ä¿å­˜å½“å‰è‚¡ç¥¨æ•°æ®
                    currentStockData = stock;
                    
                    // æ›´æ–°è‚¡ç¥¨åç§°ï¼ˆä½¿ç”¨æŸ¥è¯¢åˆ°çš„æ ‡å‡†åç§°ï¼‰
                    document.getElementById('stockName').value = stock.name;
                    
                    // æ›´æ–°PEå€¼
                    if (stock.pe && stock.pe > 0) {
                        document.getElementById('pe').value = stock.pe.toFixed(2);
                    }
                    
                    // æ›´æ–°å¢é•¿ç‡
                    if (stock.growth && stock.growth !== 0) {
                        document.getElementById('growth').value = stock.growth.toFixed(2);
                    }

                    // æ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„å…¶ä»–ä¿¡æ¯
                    showStockInfo(stock);
                } else {
                    alert('æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨æ•°æ®');
                }
            })
            .catch(error => {
                console.error('æŸ¥è¯¢é”™è¯¯:', error);
                alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                queryBtn.innerHTML = originalText;
                queryBtn.disabled = false;
            });
    }

    function showStockInfo(stock) {
        // åˆ›å»ºæˆ–æ›´æ–°è‚¡ç¥¨ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        let infoDiv = document.getElementById('stockInfo');
        if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'stockInfo';
            infoDiv.style.cssText = `
                margin-top: 15px;
                padding: 15px;
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                border-radius: 6px;
                color: white;
                font-size: 14px;
                line-height: 1.6;
            `;
            document.getElementById('stockName').closest('.input-group').appendChild(infoDiv);
        }

        let buffettScoreHtml = '';
        if (stock.buffett_score) {
            const score = stock.buffett_score;
            const totalScore = score.total_score || 0;
            const scoreColor = '#ffffff';
            const scoreLevel = totalScore >= 70 ? 'ä¼˜ç§€' : totalScore >= 50 ? 'è‰¯å¥½' : 'ä¸€èˆ¬';
            
            buffettScoreHtml = `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div style="font-weight: 700; margin-bottom: 5px;">ğŸ† å·´è²ç‰¹è¯„åˆ†</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${scoreColor};">
                        ${totalScore.toFixed(1)}åˆ† (${scoreLevel})
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                        ROE: ${(score.roe_score || 0).toFixed(1)} | 
                        ç°é‡‘æµ: ${(score.cash_flow_score || 0).toFixed(1)} | 
                        åˆ©æ¶¦å¢é•¿: ${(score.profit_growth_score || 0).toFixed(1)} | 
                        ä¼°å€¼: ${(score.valuation_score || 0).toFixed(1)}
                    </div>
                    <div style="margin-top: 8px;">
                        <button onclick="toggleBuffettDetails()" style="
                            background: rgba(255,255,255,0.2); 
                            border: 1px solid rgba(255,255,255,0.3); 
                            color: white; 
                            padding: 4px 8px; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                        ">æŸ¥çœ‹è¯¦ç»†è¯„åˆ†</button>
                    </div>
                </div>
            `;
        }

        infoDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;">ğŸ“ˆ æŸ¥è¯¢ç»“æœ</div>
            <div><strong>${stock.name}</strong> (${stock.code})</div>
            <div>è¡Œä¸š: ${stock.industry || 'æœªçŸ¥'}</div>
            <div>å½“å‰ä»·æ ¼: ${stock.current_price || 'æœªçŸ¥'}</div>
            <div>å¸‚å€¼: ${stock.market_cap ? (stock.market_cap / 100000000).toFixed(2) + 'äº¿å…ƒ' : 'æœªçŸ¥'}</div>
            ${buffettScoreHtml}
        `;
    }

    let currentStockData = null;

    function toggleBuffettDetails() {
        let detailsDiv = document.getElementById('buffettDetails');
        if (detailsDiv) {
            detailsDiv.remove();
            return;
        }

        if (!currentStockData || !currentStockData.buffett_score) {
            return;
        }

        const score = currentStockData.buffett_score;
        const infoDiv = document.getElementById('stockInfo');
        
        detailsDiv = document.createElement('div');
        detailsDiv.id = 'buffettDetails';
        detailsDiv.style.cssText = `
            margin-top: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        `;

        detailsDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 10px; color: #fff;">ğŸ“Š è¯¦ç»†è¯„åˆ†æ˜ç»†</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>ROEè¯„åˆ† (20åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.roe_score || 0).toFixed(1)}</span></div>
                <div>ç°é‡‘æµè¯„åˆ† (15åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.cash_flow_score || 0).toFixed(1)}</span></div>
                <div>åˆ©æ¶¦å¢é•¿è¯„åˆ† (15åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.profit_growth_score || 0).toFixed(1)}</span></div>
                <div>ä¼°å€¼è¯„åˆ† (15åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.valuation_score || 0).toFixed(1)}</span></div>
                <div>è´Ÿå€ºç‡è¯„åˆ† (10åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.debt_ratio_score || 0).toFixed(1)}</span></div>
                <div>æŠ¤åŸæ²³è¯„åˆ† (10åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.moat_score || 0).toFixed(1)}</span></div>
                <div>ç®¡ç†å±‚è¯„åˆ† (10åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.management_score || 0).toFixed(1)}</span></div>
                <div>ç ”å‘æŠ•å…¥è¯„åˆ† (5åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.rd_score || 0).toFixed(1)}</span></div>
                <div>åˆ†çº¢è¯„åˆ† (5åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.dividend_score || 0).toFixed(1)}</span></div>
                <div>å›è´­è¯„åˆ† (5åˆ†): <span style="color: #3498db; font-weight: 700;">${(score.repurchase_score || 0).toFixed(1)}</span></div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div style="font-weight: 700; color: #fff;">è¯„åˆ†è¯´æ˜:</div>
                <div style="margin-top: 5px; font-size: 12px; opacity: 0.9;">
                    ${(score.score_description || '').replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        infoDiv.appendChild(detailsDiv);
    }

    function loadHistory() {
        const saved = localStorage.getItem('stockCalculatorHistory');
        if (saved) {
            try {
                history = JSON.parse(saved);
                renderHistory();
            } catch (e) {
                history = [];
            }
        }
    }

    function saveHistory() {
        localStorage.setItem('stockCalculatorHistory', JSON.stringify(history));
    }

    function renderHistory() {
        const historyList = document.getElementById('historyList');

        if (history.length === 0) {
            historyList.innerHTML = '<div class="empty-history">æš‚æ— å†å²è®°å½•</div>';
            return;
        }

        historyList.innerHTML = history.map((item, index) => `
                <div class="history-item">
                    <div class="history-content" onclick="loadHistoryItem(${index})">
                        <div class="history-stock-name">${item.stockName}</div>
                        <div class="history-amount">${item.finalAmount} ä¸‡å…ƒ</div>
                        <div class="history-details">
                            PE: ${item.pe} | å¢é•¿ç‡: ${item.growth}% | PEG: ${item.peg}<br>
                            å¸‚åœºé¢„æœŸ: ${item.expect} | æŠ€æœ¯é¢: ${item.tech} | å·´è²ç‰¹: ${item.buffettScore}åˆ†<br>
                            ${item.shareCount ? `æŒè‚¡: ${item.shareCount}è‚¡ | è‚¡ä»·: ${item.currentPrice}å…ƒ` : ''}
                        </div>
                        <div class="history-time">${item.timestamp}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteHistoryItem(${index}, event)" title="åˆ é™¤è®°å½•">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
    }

    function loadHistoryItem(index) {
        const item = history[index];
        document.getElementById('stockName').value = item.stockName;
        document.getElementById('pe').value = item.pe;
        document.getElementById('growth').value = item.growth;
        document.querySelector(`input[name="expect"][value="${item.expect}"]`).checked = true;
        document.querySelector(`input[name="tech"][value="${item.tech}"]`).checked = true;

        // åªæ˜¾ç¤ºç»“æœï¼Œä¸æ·»åŠ åˆ°å†å²è®°å½•
        displayResults(item);
    }

    function deleteHistoryItem(index, event) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘loadHistoryItem
        
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
            history.splice(index, 1);
            saveHistory();
            renderHistory();
        }
    }

    function clearAllHistory() {
        if (history.length === 0) {
            alert('æ²¡æœ‰å†å²è®°å½•éœ€è¦æ¸…ç©º');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${history.length} æ¡å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            history = [];
            saveHistory();
            renderHistory();
        }
    }

    function displayResults(data) {
        const { pe, growth, peg, expect, tech, buffettScore, finalAmount, shareCount, currentPrice } = data;
        const pegScore = Math.max(0, Math.min(1, (0.5 - parseFloat(peg)) / 0.4));
        const expectScore = (parseFloat(expect) - 1) / 4;
        const techScore = parseFloat(tech) / 3;
        const buffettScoreNormalized = parseFloat(buffettScore) / 100;
        const totalScore = 0.4 * pegScore + 0.2 * expectScore + 0.2 * techScore + 0.2 * buffettScoreNormalized;

        document.getElementById('positionValue').textContent = finalAmount;
        document.getElementById('result').style.display = 'block';

        document.getElementById('peValue').textContent = pe;
        document.getElementById('growthValue').textContent = growth + '%';
        document.getElementById('pegValue').textContent = peg;
        document.getElementById('pegScore').textContent = (pegScore * 100).toFixed(2) + '%';
        document.getElementById('expectScore').textContent = (expectScore * 100).toFixed(2) + '%';
        document.getElementById('techScore').textContent = (techScore * 100).toFixed(2) + '%';
        document.getElementById('buffettScore').textContent = (buffettScoreNormalized * 100).toFixed(2) + '%';
        document.getElementById('totalScore').textContent = (totalScore * 100).toFixed(2) + '%';
        document.getElementById('breakdown').style.display = 'block';

        // æ˜¾ç¤ºæŒè‚¡æ•°é‡ä¿¡æ¯
        if (shareCount > 0 && currentPrice > 0) {
            const shareInfo = document.getElementById('shareInfo') || document.createElement('div');
            shareInfo.id = 'shareInfo';
            shareInfo.style.cssText = `
                margin-top: 15px;
                padding: 15px;
                background: rgba(52, 152, 219, 0.1);
                border-radius: 6px;
                border-left: 4px solid #3498db;
                font-size: 14px;
                line-height: 1.6;
            `;
            shareInfo.innerHTML = `
                <div style="font-weight: 700; color: #3498db; margin-bottom: 8px;">ğŸ“Š æŒè‚¡å»ºè®®</div>
                <div>å»ºè®®æŒè‚¡æ•°é‡: <span style="font-weight: 700; color: #2c3e50;">${shareCount} è‚¡</span></div>
                <div>å½“å‰è‚¡ä»·: <span style="font-weight: 700; color: #2c3e50;">${currentPrice} å…ƒ</span></div>
                <div>é¢„è®¡æŠ•èµ„é‡‘é¢: <span style="font-weight: 700; color: #2c3e50;">${(shareCount * parseFloat(currentPrice) / 10000).toFixed(2)} ä¸‡å…ƒ</span></div>
            `;
            
            const resultDiv = document.getElementById('result');
            if (!document.getElementById('shareInfo')) {
                resultDiv.parentNode.insertBefore(shareInfo, resultDiv.nextSibling);
            }
        }
    }

    function calculate() {
        const stockName = document.getElementById('stockName').value.trim();
        const pe = parseFloat(document.getElementById('pe').value);
        const growth = parseFloat(document.getElementById('growth').value);
        const expectRadio = document.querySelector('input[name="expect"]:checked');
        const techRadio = document.querySelector('input[name="tech"]:checked');

        if (!stockName) {
            alert('è¯·è¾“å…¥è‚¡ç¥¨åç§°ï¼');
            return;
        }

        if (isNaN(pe) || isNaN(growth) || !expectRadio || !techRadio) {
            alert('è¯·å¡«å†™æ‰€æœ‰å‚æ•°ï¼');
            return;
        }

        if (growth === 0) {
            alert('åˆ©æ¶¦å¢é•¿ç‡ä¸èƒ½ä¸º0ï¼');
            return;
        }

        const expect = parseFloat(expectRadio.value);
        const tech = parseFloat(techRadio.value);

        const peg = pe / growth;
        const pegScore = Math.max(0, Math.min(1, (0.5 - peg) / 0.4));
        const expectScore = (expect - 1) / 4;
        const techScore = tech / 3;
        
        // è·å–å·´è²ç‰¹è¯„åˆ†ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¾ä¸º50åˆ†ï¼ˆä¸­ç­‰æ°´å¹³ï¼‰
        const buffettScore = currentStockData && currentStockData.buffett_score ? 
            (currentStockData.buffett_score.total_score || 50) : 50;
        const buffettScoreNormalized = buffettScore / 100; // å½’ä¸€åŒ–åˆ°0-1
        
        // æ–°çš„æƒé‡åˆ†é…ï¼šPEG 40%ï¼Œå¸‚åœºé¢„æœŸ 20%ï¼ŒæŠ€æœ¯é¢ 20%ï¼Œå·´è²ç‰¹è¯„åˆ† 20%
        const totalScore = 0.4 * pegScore + 0.2 * expectScore + 0.2 * techScore + 0.2 * buffettScoreNormalized;
        const amount = 3 + 17 * totalScore;
        const finalAmount = Math.min(Math.max(amount, 3), 20);
        if(peg > 1) {
            finalAmount = 0;
        }

        // è®¡ç®—æŒè‚¡æ•°é‡ï¼ˆ100è‚¡ä¸ºå•ä½ï¼‰
        let shareCount = 0;
        let currentPrice = 0;
        if (currentStockData && currentStockData.current_price) {
            currentPrice = parseFloat(currentStockData.current_price);
            if (currentPrice > 0) {
                // è®¡ç®—èƒ½ä¹°å¤šå°‘æ‰‹ï¼ˆ1æ‰‹=100è‚¡ï¼‰
                const totalValue = finalAmount * 10000; // ä¸‡å…ƒè½¬å…ƒ
                const shares = Math.floor(totalValue / currentPrice); // æ€»è‚¡æ•°
                shareCount = Math.floor(shares / 100) * 100; // æŒ‰100è‚¡å–æ•´
            }
        }

        const timestamp = new Date().toLocaleString('zh-CN');
        const historyItem = {
            stockName,
            pe: pe.toFixed(2),
            growth: growth.toFixed(2),
            peg: peg.toFixed(3),
            expect,
            tech,
            buffettScore: buffettScore.toFixed(1),
            finalAmount: finalAmount.toFixed(2),
            shareCount: shareCount,
            currentPrice: currentPrice.toFixed(2),
            timestamp
        };

        // æ˜¾ç¤ºç»“æœ
        displayResults(historyItem);

        // æ£€æŸ¥æ˜¯å¦ä¸æœ€è¿‘ä¸€æ¡è®°å½•ç›¸åŒï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
        const isDuplicate = history.length > 0 &&
            history[0].stockName === historyItem.stockName &&
            history[0].pe === historyItem.pe &&
            history[0].growth === historyItem.growth &&
            history[0].expect === historyItem.expect &&
            history[0].tech === historyItem.tech;

        if (!isDuplicate) {
            history.unshift(historyItem);
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            saveHistory();
            renderHistory();
        }
    }

    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (input.id === 'stockName') {
                    queryStockData();
                } else {
                    calculate();
                }
            }
        });
    });

    loadHistory();
</script>
</body>
</html>