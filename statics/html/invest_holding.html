<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>买入金额计算器</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .history-panel {
            flex: 0 0 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 30px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .history-title {
            color: #34495e;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clear-all-btn {
            background: #95a5a6;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 50px;
        }

        .clear-all-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .history-content {
            flex: 1;
            cursor: pointer;
        }

        .delete-btn {
            background: #f8f9fa;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0.7;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 0;
            width: 50px;
        }

        .delete-btn:hover {
            background: #c0392b;
            opacity: 1;
            transform: scale(1.1);
        }

        .history-stock-name {
            font-weight: 700;
            color: #34495e;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .history-amount {
            color: #27ae60;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .history-details {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.6;
        }

        .history-time {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 8px;
            text-align: right;
        }

        .empty-history {
            text-align: center;
            color: #95a5a6;
            padding: 40px 20px;
            font-size: 14px;
        }

        .container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        h1 {
            color: #34495e;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #95a5a6;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #34495e;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 700;
            pointer-events: none;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 16px;
            color: #34495e;
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        #growth {
            padding-right: 40px;
        }

        .hint {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 5px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .radio-label:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .radio-label input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .radio-label input[type="radio"]:checked + .radio-text {
            color: #3498db;
            font-weight: 700;
        }

        .radio-label:has(input[type="radio"]:checked) {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .radio-text {
            color: #34495e;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .query-button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            font-size: 14px !important;
            padding: 12px 20px !important;
            margin: 0 !important;
            width: auto !important;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        .query-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%) !important;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4) !important;
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            border-radius: 6px;
            text-align: center;
            color: white;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-unit {
            font-size: 18px;
            opacity: 0.9;
        }

        .breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 6px;
            display: none;
        }

        .breakdown-title {
            color: #34495e;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .breakdown-value {
            color: #34495e;
            font-weight: 700;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .history-panel {
                flex: 1;
                max-height: 400px;
            }

            .container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- 左侧历史记录面板 -->
    <div class="history-panel">
        <div class="history-title">
            <span>📜 计算历史</span>
            <button class="clear-all-btn" onclick="clearAllHistory()" title="清空所有历史">🗑️ 清空</button>
        </div>
        <div class="history-list" id="historyList">
            <div class="empty-history">暂无历史记录</div>
        </div>
    </div>

    <!-- 右侧计算器 -->
    <div class="container">
        <h1>📊 买入金额计算器</h1>
        <p class="subtitle">基于TTM PEG、市场预期和技术面评分</p>

        <div class="input-group">
            <label for="stockName">股票名称</label>
            <div class="input-wrapper" style="display: flex; gap: 10px;">
                <input type="text" id="stockName" placeholder="例如: 贵州茅台" style="flex: 1;">
                <button type="button" id="queryBtn" class="query-button" onclick="queryStockData()">
                    🔍 查询
                </button>
            </div>
            <div class="hint">输入股票名称或代码，点击查询按钮获取最新数据</div>
        </div>

        <div class="input-group">
            <label for="pe">TTM 市盈率 (PE)</label>
            <div class="input-wrapper">
                <input type="number" id="pe" step="0.1" min="0" placeholder="例如: 15.5">
            </div>
            <div class="hint">当前市盈率</div>
        </div>

        <div class="input-group">
            <label for="growth">利润同比增长率</label>
            <div class="input-wrapper">
                <input type="number" id="growth" step="0.1" placeholder="例如: 25.5">
                <span class="input-suffix">%</span>
            </div>
            <div class="hint">利润增长百分比</div>
        </div>

        <div class="input-group">
            <label for="expect">市场预期值（手动输入）</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="expect" value="1">
                    <span class="radio-text">1 - 很差</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="2">
                    <span class="radio-text">2 - 较差</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="3" checked>
                    <span class="radio-text">3 - 中性</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="4">
                    <span class="radio-text">4 - 较好</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="expect" value="5">
                    <span class="radio-text">5 - 很好</span>
                </label>
            </div>
        </div>

        <div class="input-group">
            <label for="tech">技术面评分（手动输入）</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="tech" value="0">
                    <span class="radio-text">0 - 差</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="tech" value="1" checked>
                    <span class="radio-text">1 - 中性</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="tech" value="3">
                    <span class="radio-text">3 - 好</span>
                </label>
            </div>
        </div>

        <button onclick="calculate()">计算建议金额</button>

        <div class="result" id="result">
            <div class="result-label">建议买入金额</div>
            <div class="result-value" id="positionValue">0</div>
            <div class="result-unit">万元</div>
        </div>

        <div class="breakdown" id="breakdown">
            <div class="breakdown-title">计算明细</div>
            <div class="breakdown-item">
                <span>TTM 市盈率 (PE)</span>
                <span class="breakdown-value" id="peValue">0</span>
            </div>
            <div class="breakdown-item">
                <span>利润增长率</span>
                <span class="breakdown-value" id="growthValue">0%</span>
            </div>
            <div class="breakdown-item" style="padding-top: 10px; border-top: 1px solid #d5d8dc;">
                <span>计算得到 PEG</span>
                <span class="breakdown-value" id="pegValue">0</span>
            </div>
            <div class="breakdown-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #bdc3c7;">
                <span>PEG 得分 (40%权重)</span>
                <span class="breakdown-value" id="pegScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>市场预期得分 (20%权重)</span>
                <span class="breakdown-value" id="expectScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>技术面得分 (20%权重)</span>
                <span class="breakdown-value" id="techScore">0</span>
            </div>
            <div class="breakdown-item">
                <span>巴菲特评分 (20%权重)</span>
                <span class="breakdown-value" id="buffettScore">0</span>
            </div>
            <div class="breakdown-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #bdc3c7;">
                <span style="color: #34495e; font-weight: 700;">综合得分</span>
                <span class="breakdown-value" id="totalScore">0</span>
            </div>
        </div>
    </div>
</div>

<script>
    let history = [];

    function queryStockData() {
        const stockName = document.getElementById('stockName').value.trim();
        if (!stockName) {
            alert('请输入股票名称或代码！');
            return;
        }

        const queryBtn = document.getElementById('queryBtn');
        const originalText = queryBtn.innerHTML;
        queryBtn.innerHTML = '⏳ 查询中...';
        queryBtn.disabled = true;

        fetch(`/invest/query-stock?keyword=${encodeURIComponent(stockName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.Error) {
                    alert('查询失败: ' + data.Error);
                    return;
                }

                if (data.StockData) {
                    const stock = data.StockData;
                    // 保存当前股票数据
                    currentStockData = stock;
                    
                    // 更新股票名称（使用查询到的标准名称）
                    document.getElementById('stockName').value = stock.name;
                    
                    // 更新PE值
                    if (stock.pe && stock.pe > 0) {
                        document.getElementById('pe').value = stock.pe.toFixed(2);
                    }
                    
                    // 更新增长率
                    if (stock.growth && stock.growth !== 0) {
                        document.getElementById('growth').value = stock.growth.toFixed(2);
                    }

                    // 显示查询到的其他信息
                    showStockInfo(stock);
                } else {
                    alert('未找到相关股票数据');
                }
            })
            .catch(error => {
                console.error('查询错误:', error);
                alert('查询失败，请稍后重试');
            })
            .finally(() => {
                queryBtn.innerHTML = originalText;
                queryBtn.disabled = false;
            });
    }

    function showStockInfo(stock) {
        // 创建或更新股票信息显示区域
        let infoDiv = document.getElementById('stockInfo');
        if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'stockInfo';
            infoDiv.style.cssText = `
                margin-top: 15px;
                padding: 15px;
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                border-radius: 6px;
                color: white;
                font-size: 14px;
                line-height: 1.6;
            `;
            document.getElementById('stockName').closest('.input-group').appendChild(infoDiv);
        }

        let buffettScoreHtml = '';
        if (stock.buffett_score) {
            const score = stock.buffett_score;
            const totalScore = score.total_score || 0;
            const scoreColor = '#ffffff';
            const scoreLevel = totalScore >= 70 ? '优秀' : totalScore >= 50 ? '良好' : '一般';
            
            buffettScoreHtml = `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div style="font-weight: 700; margin-bottom: 5px;">🏆 巴菲特评分</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${scoreColor};">
                        ${totalScore.toFixed(1)}分 (${scoreLevel})
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                        ROE: ${(score.roe_score || 0).toFixed(1)} | 
                        现金流: ${(score.cash_flow_score || 0).toFixed(1)} | 
                        利润增长: ${(score.profit_growth_score || 0).toFixed(1)} | 
                        估值: ${(score.valuation_score || 0).toFixed(1)}
                    </div>
                    <div style="margin-top: 8px;">
                        <button onclick="toggleBuffettDetails()" style="
                            background: rgba(255,255,255,0.2); 
                            border: 1px solid rgba(255,255,255,0.3); 
                            color: white; 
                            padding: 4px 8px; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                        ">查看详细评分</button>
                    </div>
                </div>
            `;
        }

        infoDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;">📈 查询结果</div>
            <div><strong>${stock.name}</strong> (${stock.code})</div>
            <div>行业: ${stock.industry || '未知'}</div>
            <div>当前价格: ${stock.current_price || '未知'}</div>
            <div>市值: ${stock.market_cap ? (stock.market_cap / 100000000).toFixed(2) + '亿元' : '未知'}</div>
            ${buffettScoreHtml}
        `;
    }

    let currentStockData = null;

    function toggleBuffettDetails() {
        let detailsDiv = document.getElementById('buffettDetails');
        if (detailsDiv) {
            detailsDiv.remove();
            return;
        }

        if (!currentStockData || !currentStockData.buffett_score) {
            return;
        }

        const score = currentStockData.buffett_score;
        const infoDiv = document.getElementById('stockInfo');
        
        detailsDiv = document.createElement('div');
        detailsDiv.id = 'buffettDetails';
        detailsDiv.style.cssText = `
            margin-top: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        `;

        detailsDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 10px; color: #fff;">📊 详细评分明细</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>ROE评分 (20分): <span style="color: #3498db; font-weight: 700;">${(score.roe_score || 0).toFixed(1)}</span></div>
                <div>现金流评分 (15分): <span style="color: #3498db; font-weight: 700;">${(score.cash_flow_score || 0).toFixed(1)}</span></div>
                <div>利润增长评分 (15分): <span style="color: #3498db; font-weight: 700;">${(score.profit_growth_score || 0).toFixed(1)}</span></div>
                <div>估值评分 (15分): <span style="color: #3498db; font-weight: 700;">${(score.valuation_score || 0).toFixed(1)}</span></div>
                <div>负债率评分 (10分): <span style="color: #3498db; font-weight: 700;">${(score.debt_ratio_score || 0).toFixed(1)}</span></div>
                <div>护城河评分 (10分): <span style="color: #3498db; font-weight: 700;">${(score.moat_score || 0).toFixed(1)}</span></div>
                <div>管理层评分 (10分): <span style="color: #3498db; font-weight: 700;">${(score.management_score || 0).toFixed(1)}</span></div>
                <div>研发投入评分 (5分): <span style="color: #3498db; font-weight: 700;">${(score.rd_score || 0).toFixed(1)}</span></div>
                <div>分红评分 (5分): <span style="color: #3498db; font-weight: 700;">${(score.dividend_score || 0).toFixed(1)}</span></div>
                <div>回购评分 (5分): <span style="color: #3498db; font-weight: 700;">${(score.repurchase_score || 0).toFixed(1)}</span></div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div style="font-weight: 700; color: #fff;">评分说明:</div>
                <div style="margin-top: 5px; font-size: 12px; opacity: 0.9;">
                    ${(score.score_description || '').replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        infoDiv.appendChild(detailsDiv);
    }

    function loadHistory() {
        const saved = localStorage.getItem('stockCalculatorHistory');
        if (saved) {
            try {
                history = JSON.parse(saved);
                renderHistory();
            } catch (e) {
                history = [];
            }
        }
    }

    function saveHistory() {
        localStorage.setItem('stockCalculatorHistory', JSON.stringify(history));
    }

    function renderHistory() {
        const historyList = document.getElementById('historyList');

        if (history.length === 0) {
            historyList.innerHTML = '<div class="empty-history">暂无历史记录</div>';
            return;
        }

        historyList.innerHTML = history.map((item, index) => `
                <div class="history-item">
                    <div class="history-content" onclick="loadHistoryItem(${index})">
                        <div class="history-stock-name">${item.stockName}</div>
                        <div class="history-amount">${item.finalAmount} 万元</div>
                        <div class="history-details">
                            PE: ${item.pe} | 增长率: ${item.growth}% | PEG: ${item.peg}<br>
                            市场预期: ${item.expect} | 技术面: ${item.tech} | 巴菲特: ${item.buffettScore}分<br>
                            ${item.shareCount ? `持股: ${item.shareCount}股 | 股价: ${item.currentPrice}元` : ''}
                        </div>
                        <div class="history-time">${item.timestamp}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteHistoryItem(${index}, event)" title="删除记录">
                        🗑️
                    </button>
                </div>
            `).join('');
    }

    function loadHistoryItem(index) {
        const item = history[index];
        document.getElementById('stockName').value = item.stockName;
        document.getElementById('pe').value = item.pe;
        document.getElementById('growth').value = item.growth;
        document.querySelector(`input[name="expect"][value="${item.expect}"]`).checked = true;
        document.querySelector(`input[name="tech"][value="${item.tech}"]`).checked = true;

        // 只显示结果，不添加到历史记录
        displayResults(item);
    }

    function deleteHistoryItem(index, event) {
        event.stopPropagation(); // 阻止事件冒泡，避免触发loadHistoryItem
        
        if (confirm('确定要删除这条历史记录吗？')) {
            history.splice(index, 1);
            saveHistory();
            renderHistory();
        }
    }

    function clearAllHistory() {
        if (history.length === 0) {
            alert('没有历史记录需要清空');
            return;
        }
        
        if (confirm(`确定要清空所有 ${history.length} 条历史记录吗？此操作不可恢复！`)) {
            history = [];
            saveHistory();
            renderHistory();
        }
    }

    function displayResults(data) {
        const { pe, growth, peg, expect, tech, buffettScore, finalAmount, shareCount, currentPrice } = data;
        const pegScore = Math.max(0, Math.min(1, (0.5 - parseFloat(peg)) / 0.4));
        const expectScore = (parseFloat(expect) - 1) / 4;
        const techScore = parseFloat(tech) / 3;
        const buffettScoreNormalized = parseFloat(buffettScore) / 100;
        const totalScore = 0.4 * pegScore + 0.2 * expectScore + 0.2 * techScore + 0.2 * buffettScoreNormalized;

        document.getElementById('positionValue').textContent = finalAmount;
        document.getElementById('result').style.display = 'block';

        document.getElementById('peValue').textContent = pe;
        document.getElementById('growthValue').textContent = growth + '%';
        document.getElementById('pegValue').textContent = peg;
        document.getElementById('pegScore').textContent = (pegScore * 100).toFixed(2) + '%';
        document.getElementById('expectScore').textContent = (expectScore * 100).toFixed(2) + '%';
        document.getElementById('techScore').textContent = (techScore * 100).toFixed(2) + '%';
        document.getElementById('buffettScore').textContent = (buffettScoreNormalized * 100).toFixed(2) + '%';
        document.getElementById('totalScore').textContent = (totalScore * 100).toFixed(2) + '%';
        document.getElementById('breakdown').style.display = 'block';

        // 显示持股数量信息
        if (shareCount > 0 && currentPrice > 0) {
            const shareInfo = document.getElementById('shareInfo') || document.createElement('div');
            shareInfo.id = 'shareInfo';
            shareInfo.style.cssText = `
                margin-top: 15px;
                padding: 15px;
                background: rgba(52, 152, 219, 0.1);
                border-radius: 6px;
                border-left: 4px solid #3498db;
                font-size: 14px;
                line-height: 1.6;
            `;
            shareInfo.innerHTML = `
                <div style="font-weight: 700; color: #3498db; margin-bottom: 8px;">📊 持股建议</div>
                <div>建议持股数量: <span style="font-weight: 700; color: #2c3e50;">${shareCount} 股</span></div>
                <div>当前股价: <span style="font-weight: 700; color: #2c3e50;">${currentPrice} 元</span></div>
                <div>预计投资金额: <span style="font-weight: 700; color: #2c3e50;">${(shareCount * parseFloat(currentPrice) / 10000).toFixed(2)} 万元</span></div>
            `;
            
            const resultDiv = document.getElementById('result');
            if (!document.getElementById('shareInfo')) {
                resultDiv.parentNode.insertBefore(shareInfo, resultDiv.nextSibling);
            }
        }
    }

    function calculate() {
        const stockName = document.getElementById('stockName').value.trim();
        const pe = parseFloat(document.getElementById('pe').value);
        const growth = parseFloat(document.getElementById('growth').value);
        const expectRadio = document.querySelector('input[name="expect"]:checked');
        const techRadio = document.querySelector('input[name="tech"]:checked');

        if (!stockName) {
            alert('请输入股票名称！');
            return;
        }

        if (isNaN(pe) || isNaN(growth) || !expectRadio || !techRadio) {
            alert('请填写所有参数！');
            return;
        }

        if (growth === 0) {
            alert('利润增长率不能为0！');
            return;
        }

        const expect = parseFloat(expectRadio.value);
        const tech = parseFloat(techRadio.value);

        const peg = pe / growth;
        const pegScore = Math.max(0, Math.min(1, (0.5 - peg) / 0.4));
        const expectScore = (expect - 1) / 4;
        const techScore = tech / 3;
        
        // 获取巴菲特评分，如果没有则设为50分（中等水平）
        const buffettScore = currentStockData && currentStockData.buffett_score ? 
            (currentStockData.buffett_score.total_score || 50) : 50;
        const buffettScoreNormalized = buffettScore / 100; // 归一化到0-1
        
        // 新的权重分配：PEG 40%，市场预期 20%，技术面 20%，巴菲特评分 20%
        const totalScore = 0.4 * pegScore + 0.2 * expectScore + 0.2 * techScore + 0.2 * buffettScoreNormalized;
        const amount = 3 + 17 * totalScore;
        const finalAmount = Math.min(Math.max(amount, 3), 20);
        if(peg > 1) {
            finalAmount = 0;
        }

        // 计算持股数量（100股为单位）
        let shareCount = 0;
        let currentPrice = 0;
        if (currentStockData && currentStockData.current_price) {
            currentPrice = parseFloat(currentStockData.current_price);
            if (currentPrice > 0) {
                // 计算能买多少手（1手=100股）
                const totalValue = finalAmount * 10000; // 万元转元
                const shares = Math.floor(totalValue / currentPrice); // 总股数
                shareCount = Math.floor(shares / 100) * 100; // 按100股取整
            }
        }

        const timestamp = new Date().toLocaleString('zh-CN');
        const historyItem = {
            stockName,
            pe: pe.toFixed(2),
            growth: growth.toFixed(2),
            peg: peg.toFixed(3),
            expect,
            tech,
            buffettScore: buffettScore.toFixed(1),
            finalAmount: finalAmount.toFixed(2),
            shareCount: shareCount,
            currentPrice: currentPrice.toFixed(2),
            timestamp
        };

        // 显示结果
        displayResults(historyItem);

        // 检查是否与最近一条记录相同（避免重复添加）
        const isDuplicate = history.length > 0 &&
            history[0].stockName === historyItem.stockName &&
            history[0].pe === historyItem.pe &&
            history[0].growth === historyItem.growth &&
            history[0].expect === historyItem.expect &&
            history[0].tech === historyItem.tech;

        if (!isDuplicate) {
            history.unshift(historyItem);
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            saveHistory();
            renderHistory();
        }
    }

    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (input.id === 'stockName') {
                    queryStockData();
                } else {
                    calculate();
                }
            }
        });
    });

    loadHistory();
</script>
</body>
</html>